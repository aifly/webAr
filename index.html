
<!DOCTYPE html>
<!--
 *  Copyright (c) 2015 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
-->
<html>
<head>

  <meta charset="utf-8">
  <meta name="description" content="WebRTC code samples">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
  <meta itemprop="description" content="Client-side WebRTC code samples">
  <meta itemprop="image" content="../../../images/webrtc-icon-192x192.png">
  <meta itemprop="name" content="WebRTC code samples">
  <meta name="mobile-web-app-capable" content="yes">

  <base target="_blank">
  
  <script>
    document.addEventListener('touchmove',function(e){e.preventDefault()})
  </script>
  <title>拉取后置摄像头</title>

  
  <style>
    *{margin:0;padding:0}
    
    video{
      position:absolute;
    }
    body,html{
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }

    .zmiti-box{
      position: absolute;
      z-index: 10;
      color:#fff;
      left: 40%;
      top: 50%;
    }
  #gum-local{
    position: absolute;
    left: 40%;
    top: 50%;
    width: 100%;
    height: 100%;
    -webkit-transform-origin: center 80%;
    -webkit-transform:translate(-50%,-50%) scale(1.2);
  }

  .zmiti-video-box{
    position: relative;
    left: 0;top:0;
    z-index: 1
  }
  canvas{
    position: absolute;
    left: 0;top: 0;
    z-index: 100;
  }
  </style>
  

</head>

<body>

     <div class="zmiti-video-box">
        <video id="gum-local" autoplay playsinline></video>
     </div>


    <div id="errorMsg"></div>

<script src="https://cdn.bootcss.com/three.js/r83/three.min.js"></script>
<script src='./js/OBJLoader.js'></script>
<script src='./js/TrackballControls.js'></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script>
   !function(){

        var viewW = document.documentElement.clientWidth,
            viewH = document.documentElement.clientHeight;

        
        var scene = new THREE.Scene();


        var renderer = new THREE.WebGLRenderer({     alpha:true,
            antialias: true}  );

        renderer.setSize(viewW,viewH);
        renderer.setClearAlpha(0);

        var camera = new THREE.PerspectiveCamera( 45,viewW/viewH, .1, 2000 );

        camera.position.set(0,0,100);

        camera.lookAt(scene.position);

        scene.add(camera);

        var geometry = new THREE.Geometry();

        var sprite = new THREE.TextureLoader().load( "./images/disc.png" );

        for(var i =0 ; i<40;i++){
            var vertex = new THREE.Vector3();
            vertex.x = Math.random() * 200 - 100;
            vertex.y = Math.random() * 200 - 100;
            vertex.z = Math.random() * 200 - 100;


            geometry.vertices.push(vertex);
        }

        var pointColor = "#ffffff";
        var directionalLight = new THREE.DirectionalLight(pointColor);
        directionalLight.position.set(-40, 60, -10);
        directionalLight.castShadow = true;
        directionalLight.shadowCameraNear = 2;
        directionalLight.shadowCameraFar = 200;
        directionalLight.shadowCameraLeft = -50;
        directionalLight.shadowCameraRight = 50;
        directionalLight.shadowCameraTop = 50;
        directionalLight.shadowCameraBottom = -50;

        directionalLight.distance = 0;
        directionalLight.intensity = 0.5;
        directionalLight.shadowMapHeight = 1024;
        directionalLight.shadowMapWidth = 1024;


        scene.add(directionalLight);


        var manager = new THREE.LoadingManager();

        manager.onProgress = function(item,loaded,total){
            console.log(item,loaded,total);
        }

        var loader = new THREE.OBJLoader( manager );

        var object = null;
        loader.load('./data/snowman.obj',function(obj){
            obj.traverse( function ( child ) {
              /*if ( child instanceof THREE.Mesh ) {
                child.material.map = texture;
              }*/
            } );
            obj.position.y = -10;
            object = obj;
            scene.add( obj );
        });


        var clock = new THREE.Clock();

        var trackballControls = new THREE.TrackballControls(camera);

        trackballControls.rotateSpeed = 1.0;
        trackballControls.zoomSpeed = 1.0;
        trackballControls.panSpeed = 1.0;
//        trackballControls.noZoom=false;
//        trackballControls.noPan=false;
        trackballControls.staticMoving = true;



        var materails = [];
        geometry.vertices.forEach(function(param,i){
                var size = Math.random()*2+.7;
                var particles = new THREE.Points(geometry,new THREE.PointsMaterial({size:size,map:sprite,transparent:true}));
                particles.speedY = (Math.random()+.1);
                particles.speedX = (Math.random())*(Math.random()-.5>0?1:-1);
                particles.speedY = particles.speedY.toFixed(2)
                particles.speedX = particles.speedX.toFixed(2)
                scene.add( particles );
        })
       

        var pointLight = new THREE.PointLight( 0xffffff,1,1000 );
        scene.add(pointLight)

        document.body.appendChild(renderer.domElement);
        var i = 0;
        var render = function(){

            //camera.position.x += (  camera.position.x ) * 0.05;
            //camera.position.y += (  - camera.position.y ) * 0.05;
            //camera.lookAt( scene.position );

            trackballControls.update(clock.getDelta());
            //object && (object.rotation.y+=.01);
            pointLight.position.x = Math.sin(i*Math.PI/180)*300;
            pointLight.position.y = Math.cos(i*Math.PI/180)*300;
            i+=.2;
             scene.children.forEach(function(child,i){
                if(child instanceof THREE.Points){
                    if(child.position.y<-70){
                        child.position.y = 70;
                    }
                    if(child.position.x<-30){
                        child.position.x = 30;
                    }
                   child.position.y -= child.speedY;
                   child.position.x -= child.speedX;
                }
             })

          renderer.render(scene,camera);    
          requestAnimationFrame(render);
        }

        
        render();

    }()
</script>
  <script>

'use strict';
 /* exported trace */

// Logging utility function.

var errorElement = document.querySelector('#errorMsg');
var video = document.querySelector('video');
    
if(navigator.getUserMedia){
  navigator.mediaDevices.enumerateDevices().then(function (sourceInfos) {  
  var videoBox = document.querySelector('.zmiti-video-box');
  videoBox.style.width = document.documentElement.clientWidth+'px';
  videoBox.style.height = document.documentElement.clientHeight+'px';

    
var constraints = window.constraints = {
  audio: false,
  video: {
    facingMode:'environment'
  }
};

function handleSuccess(stream) {
  var videoTracks = stream.getVideoTracks();
  //console.log('Got stream with constraints:', constraints);
  //console.log('Using video device: ' + videoTracks[0].label);
  stream.oninactive = function() {
    console.log('Stream inactive');
  };
  window.stream = stream; // make variable available to browser console
  video.srcObject = stream;
}

function handleError(error) {
  if (error.name === 'ConstraintNotSatisfiedError') {
    errorMsg('The resolution ' + constraints.video.width.exact + 'x' +
        constraints.video.width.exact + ' px is not supported by your device.');
  } else if (error.name === 'PermissionDeniedError') {
    errorMsg('Permissions have not been granted to use your camera and ' +
      'microphone, you need to allow the page access to your devices in ' +
      'order for the demo to work.');
  }
  errorMsg('getUserMedia error: ' + error.name, error);
}

function errorMsg(msg, error) {
  errorElement.innerHTML += '<p>' + msg + '</p>';
  if (typeof error !== 'undefined') {
    console.error(error);
  }
}

navigator.mediaDevices.getUserMedia(constraints).
    then(handleSuccess).catch(handleError);
  });
}



// Put variables in global scope to make them available to the browser console.

  </script>


</body>
</html>
